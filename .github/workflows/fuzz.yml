name: Fuzzing

on:
  pull_request:
    paths:
      - 'internal/**/*.go'
      - 'cmd/**/*.go'
      - 'go.mod'
      - 'go.sum'
      - '.github/workflows/fuzz.yml'
  schedule:
    # Run comprehensive fuzzing daily at 2 AM UTC
    - cron: '0 2 * * *'
  workflow_dispatch:
    inputs:
      fuzztime:
        description: 'Fuzz time per target (e.g., 1m, 10m, 1h)'
        required: false
        default: '10m'

permissions:
  contents: read

jobs:
  fuzz-string-extraction:
    name: Fuzz String Extraction
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        target:
          - FuzzExtractASCII
          - FuzzExtractUTF8Aware
          - FuzzExtractUTF16
          - FuzzExtractUTF32
          - FuzzFilterPatterns
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: stable
          cache: true

      - name: Restore fuzz corpus cache
        uses: actions/cache@v4
        with:
          path: ~/.cache/go-build/fuzz
          key: fuzz-corpus-extractor-${{ matrix.target }}-${{ github.sha }}
          restore-keys: |
            fuzz-corpus-extractor-${{ matrix.target }}-

      - name: Determine fuzz time
        id: fuzztime
        run: |
          if [ "${{ github.event_name }}" = "pull_request" ]; then
            echo "time=2m" >> $GITHUB_OUTPUT
          elif [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "time=${{ github.event.inputs.fuzztime }}" >> $GITHUB_OUTPUT
          else
            echo "time=1h" >> $GITHUB_OUTPUT
          fi

      - name: Run fuzzing
        run: |
          set -o pipefail
          go test -v -fuzz=${{ matrix.target }} -fuzztime=${{ steps.fuzztime.outputs.time }} ./internal/extractor 2>&1 | tee fuzz-${{ matrix.target }}.log
        timeout-minutes: 90

      - name: Upload fuzz logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: fuzz-logs-extractor-${{ matrix.target }}
          path: fuzz-*.log
          retention-days: 7

      - name: Check for failures
        if: failure()
        run: |
          echo "::error::Fuzzing failed for ${{ matrix.target }}"
          if [ -f fuzz-${{ matrix.target }}.log ]; then
            echo "::group::Fuzz output"
            cat fuzz-${{ matrix.target }}.log
            echo "::endgroup::"
          fi

  fuzz-binary-parsers:
    name: Fuzz Binary Parsers
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        target:
          - FuzzParseELF
          - FuzzParsePE
          - FuzzParseMachO
          - FuzzDetectFormat
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: stable
          cache: true

      - name: Restore fuzz corpus cache
        uses: actions/cache@v4
        with:
          path: ~/.cache/go-build/fuzz
          key: fuzz-corpus-binary-${{ matrix.target }}-${{ github.sha }}
          restore-keys: |
            fuzz-corpus-binary-${{ matrix.target }}-

      - name: Determine fuzz time
        id: fuzztime
        run: |
          if [ "${{ github.event_name }}" = "pull_request" ]; then
            echo "time=2m" >> $GITHUB_OUTPUT
          elif [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "time=${{ github.event.inputs.fuzztime }}" >> $GITHUB_OUTPUT
          else
            echo "time=1h" >> $GITHUB_OUTPUT
          fi

      - name: Run fuzzing
        run: |
          set -o pipefail
          go test -v -fuzz=${{ matrix.target }} -fuzztime=${{ steps.fuzztime.outputs.time }} ./internal/binary 2>&1 | tee fuzz-${{ matrix.target }}.log
        timeout-minutes: 90

      - name: Upload fuzz logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: fuzz-logs-binary-${{ matrix.target }}
          path: fuzz-*.log
          retention-days: 7

      - name: Check for failures
        if: failure()
        run: |
          echo "::error::Fuzzing failed for ${{ matrix.target }}"
          if [ -f fuzz-${{ matrix.target }}.log ]; then
            echo "::group::Fuzz output"
            cat fuzz-${{ matrix.target }}.log
            echo "::endgroup::"
          fi

  fuzz-summary:
    name: Fuzzing Summary
    runs-on: ubuntu-latest
    needs: [fuzz-string-extraction, fuzz-binary-parsers]
    if: always()
    steps:
      - name: Check fuzzing results
        run: |
          if [ "${{ needs.fuzz-string-extraction.result }}" != "success" ] || [ "${{ needs.fuzz-binary-parsers.result }}" != "success" ]; then
            echo "::error::One or more fuzzing jobs failed"
            exit 1
          fi
          echo "::notice::All fuzzing jobs completed successfully"
